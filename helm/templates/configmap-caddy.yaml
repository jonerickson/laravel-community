apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "app.fullname" . }}-caddy
  labels:
    {{- include "app.labels" . | nindent 4 }}
data:
  Caddyfile: |
    {
      {{- if eq .Values.environment "local" }}
      # Local development - no HTTPS
      auto_https off
      {{- else }}
      # Production/Staging - automatic HTTPS
      email {{ .Values.caddy.email }}
      {{- end }}
    }

    {{- if eq .Values.environment "local" }}
    # Local HTTP only
    :80 {
      reverse_proxy {{ include "app.fullname" . }}-web:8080 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
      }

      log {
        output stdout
        format console
      }
    }
    {{- else }}
    # Production/Staging with HTTPS
    {{ .Values.app.url }} {
      reverse_proxy {{ include "app.fullname" . }}-web:8080 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
      }

      encode gzip

      log {
        output stdout
        format console
      }
    }
    {{- end }}
